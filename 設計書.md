# TODOアプリ設計書

## 1. 概要
- タスクを追加・編集・削除・完了管理できるWebアプリ
- 各タスクに通知時刻を設定し、指定時刻にデスクトップ通知を表示

---

## 2. 機能一覧

| 機能                | 詳細                                                         |
|---------------------|-------------------------------------------------------------|
| タスク追加          | タイトル・詳細・通知時刻を入力してタスクを追加               |
| タスク編集          | 既存タスクの内容や通知時刻を編集                            |
| タスク削除          | タスクを削除（即時消去せず、完了タスクと同じタイミングで自動削除） |
| タスク完了/未完了   | タスクの状態を切り替え                                       |
| タスク一覧表示      | 追加済みタスクを一覧表示                                     |
| タスク検索/フィルタ | タイトルや状態でタスクを検索・フィルタ                       |
| デスクトップ通知    | 通知時刻になるとブラウザの通知APIでデスクトップ通知を表示     |
| リマインダー機能    | タスクごとに「15分前」「10分前」「5分前」のリマインダー通知を設定できる |

## 2.1. 完了タスクおよび削除タスクの自動削除仕様

- 完了にしたタスクおよび削除操作を行ったタスクは「完了または削除から1日後」に自動削除する。
- サーバー処理は行わず、「画面を起動したとき」に前回起動時から日付が変わっていれば削除処理を実行する。
- 削除対象は「完了日または削除日が前日以前」のタスクとする。
- タスクに `completedAt`（完了日時）および `deletedAt`（削除日時）を持たせる。
- アプリ起動時に「最終起動日時」と「現在日時」を比較し、日をまたいでいれば削除処理を行う。
- 最終起動日時はlocalStorage等に保存する。

---

## 3. 画面設計（ページ構成）

- `/`（トップページ）
  - タスク一覧
  - 追加ボタン（常に押下可）
    - 押下時、タスク一覧の先頭に空行（入力欄）を表示
    - 入力後「確定」ボタンで新規タスクを追加
    - 「確定」ボタンは追加ボタン押下時のみ押下可
  - 編集ボタン（タスクがあるときのみ押下可）
    - 押下時、該当タスク行が編集可能状態になる
    - 入力後「確定」ボタンで編集内容を反映
    - 「確定」ボタンは編集ボタン押下時のみ押下可
  - 各タスクの削除・完了ボタン（削除は即時消去せず、削除タスクとしてフラグ管理）
  - リマインダー設定ボタン
    - 押下時、リマインダー設定ダイアログを表示
    - 設定後、タスクにリマインダー情報を保存

---

## 4. データ構造

- 必須項目: ID、タイトル、説明、期日、完了フラグ、完了時刻、削除フラグ、削除時刻、作成時刻、リマインダー設定、色、タグ

```typescript
type Todo = {
  id: string;               // 一意なID
  title: string;            // タイトル
  description: string;      // 説明
  dueDateTime: Date;        // 期日
  completed: boolean;       // 完了フラグ
  completedAt?: Date;       // 完了時刻（未完了時はnull）
  deleted: boolean;         // 削除フラグ
  deletedAt?: Date;         // 削除時刻（削除されていない時はnull）
  createdAt: Date;          // 作成時刻
  reminders: number[];      // リマインダー（分前の配列、例: [15,10,5]）
  color: 'red' | 'green' | 'orange' | 'yellow' | 'white'; // タスク色（デフォルトはwhite）
  tags?: string[]; // タグ（任意）
};
```

### データベース（sql.js/SQLite）テーブル定義

```sql
CREATE TABLE todos (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  due_date_time TEXT NOT NULL,
  completed INTEGER NOT NULL,
  completed_at TEXT,
  deleted INTEGER NOT NULL,
  deleted_at TEXT,
  created_at TEXT NOT NULL,
  reminders TEXT, -- JSON形式で格納
  color TEXT DEFAULT 'white',
  tags TEXT -- JSON形式で格納
);
```

---

## 4. Googleカレンダー連携

| 機能                         | 詳細                                                                 |
|------------------------------|----------------------------------------------------------------------|
| Googleカレンダー認証         | Googleアカウントでログインし、カレンダー操作の権限を取得             |
| タスク→予定の自動同期        | タスクを追加・編集・削除すると、Googleカレンダーの予定も自動で同期     |
| 予定の追加                   | タスク追加時、Googleカレンダーにも同内容の予定を作成                  |
| 予定の編集                   | タスク編集時、対応するGoogleカレンダーの予定も自動で編集               |
| 予定の削除                   | タスク削除時、対応するGoogleカレンダーの予定も自動で削除               |
| 連携解除                     | ユーザーがGoogle連携を解除できる（サインアウト）                      |

### 4.1. 連携仕様
- 各タスクにGoogleカレンダーのイベントIDを保持し、同期・編集・削除時に利用する
- タスクのタイトル・説明・通知時刻をGoogleカレンダーのイベントに反映
- 通知時刻はイベントの開始時刻として登録
- 連携失敗時は日本語でエラーメッセージを表示
- UI上のボタン・メッセージ・ダイアログ等は全て日本語表記とする

### 4.2. データベースとGoogleカレンダーの一貫性維持
- タスクの追加・編集・削除時は、必ずローカルDB（sql.js/IndexedDB）とGoogleカレンダーの両方に同じ内容を反映し、一貫性を保つ
- いずれかの操作が失敗した場合はロールバックやエラーメッセージを表示し、データの不整合を防ぐ
- タスクの同期状態（例：同期済み・同期失敗など）をDBに記録し、UIで分かりやすく表示する

### 4.3. Googleカレンダー予定登録仕様
- Googleカレンダーに登録する予定は、時間帯に関係なく「終日イベント」として登録する
- タスクの期日（dueDateTime）はGoogleカレンダーの「start.date」「end.date」に反映（end.dateはstart.dateの翌日）
- 通知やリマインダーはアプリ側で管理し、Googleカレンダーの通知機能は利用しない

### 4.4. Googleカレンダー予定の削除・同期ルール
- タスク削除時、対応するGoogleカレンダー予定も削除するかどうか必ずユーザーに確認する（確認ダイアログを表示）
- Googleカレンダー側にしか存在しない予定（＝アプリのタスクDBに紐付かないイベント）は、ToDoアプリ上には一切表示しない
- タスク追加・編集時は必ずGoogleカレンダーにも新規作成・更新を行い、問答無用で同期する（ユーザー確認不要）

---

## 5. UI日本語化方針
- 画面上の全てのボタン、ラベル、ダイアログ、エラーメッセージを日本語で表示
- Google認証・カレンダー連携エラーも日本語で案内
- ユーザー向けヘルプや説明文も日本語で記載

---

## 6. リマインダー機能

- タスクごとに「15分前」「10分前」「5分前」のリマインダー通知を設定できるチェックボックスを用意する。
- チェックされた時間分前にデスクトップ通知を行う。
- 設定は複数同時に選択可能。

---

## 7. 通知機能のポイント

- ユーザーの通知許可を取得（初回アクセス時）
- タスクの通知時刻を監視し、時刻になったらNotification APIで通知
- 通知内容：タスクタイトルと簡単な説明

---

## 8. 通知機能の仕様（詳細）

- 通知のタイトルにはタスクのタイトルを表示する。
- 通知時刻の精度は「秒単位」とする。
- 通知の繰り返し設定はユーザーに選択させる。
- 通知許可が拒否された場合は何も表示しないが、再度アプリを開いたときに再び通知許可をリクエストする。

---

## 9. 他端末との同期（将来拡張）

- 現状はローカル保存のみだが、将来的な他端末同期を見据えた設計とする。
- タスクデータに一意なID（UUID等）を付与し、更新日時や端末識別情報を持たせる拡張性を考慮する。
- データ保存・取得処理は同期API追加時に差し替えやすい構造にする。

---

## 10. データ保存方式

- データベースには「sql.js（WebAssembly版SQLite）」を利用し、SQL文でタスクデータを管理する。
- データベースファイルは「IndexedDB」を利用してブラウザ内に永続化する。
- アプリ起動時にIndexedDBからデータベースを読み込み、終了・更新時に保存することで、タスクデータを保持し続ける。
- この方式により、ページリロードや開発サーバー（yarn dev）の停止・再起動後もタスクデータは失われない。
- サーバーを用意せず、フロントエンドのみで本格的なDB操作と永続化を両立する。

---

## 11. UI/UX設計方針

- シンプルでスタイリッシュなデザイン
- レスポンシブ対応（スマートフォンでも快適に利用可能）
- ダークモード対応
- タスク一覧は期日（dueDateTime）が近い順に自動で並び替えて表示する

---

## 12. 通知許可の仕様

- アプリ起動時にNotification APIで通知許可をリクエストする
- 許可済みの場合は再度ダイアログを表示しない
- 拒否された場合は何も表示しない
- 再度アプリを開いた場合は再び通知許可をリクエストする

---

## 13. タスクの色分け・タグ付け

- タスクごとに色分け・タグ付けが可能。
- 期日を過ぎていて未完了のタスクは「赤」で強調表示。
- それ以外のタスクは「薄緑」「薄オレンジ」「黄色」から色を選択して変更できる。
- 色を選択しなかった場合は「白（デフォルト）」で表示する。
- 色はタスクの視認性と優先度の目安として利用。
- タグ付け機能は今後の拡張も考慮し、任意の文字列タグを複数付与できる設計とする。

---

## 14. 日時入力UI（カレンダー表示）

- タスクの期日や完了日時など、日時を入力する際は簡易カレンダー（DatePicker）を表示する。
- カレンダーは日付・時間の両方を選択できるUIとする。
- デフォルト値は「現在日付・時刻」とする。
- 日付入力欄はタスク追加・編集時に必須項目として表示。

---

## 15. 技術要素・ライブラリ

- Next.js（フロントエンド/サーバーサイドレンダリング）
- TypeScript
- 状態管理：useState, useReducer, Context APIなど
- デスクトップ通知：Notification API（ブラウザ標準）
- スタイリング：Tailwind CSS（初期テンプレートに含まれている場合）
- DB操作・永続化：sql.js（WebAssembly版SQLite）、IndexedDB

---

## 16. フォント・アイコン
- 画面全体のフォントは [Google Fonts](https://fonts.google.com/) から選択して利用する
- 画面・UIパーツのアイコンは [Boxicons](https://boxicons.com/) を利用する
- フォント・アイコンともにWebフォント/CDN経由で読み込み、パフォーマンスとデザイン性を両立する

---
